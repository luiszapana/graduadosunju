<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Editar Graduado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{layout :: layout(~{::content})}">

    <div th:fragment="content">
        <div class="container mt-4">
            <h3>Editar Graduado (Administración)</h3>

            <form th:action="@{'/admin/graduados/' + ${editarGraduadoAdminDTO.id} + '/editar'}"
                  th:object="${editarGraduadoAdminDTO}"
                  method="post">

                <!-- CSRF -->
<!--
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
-->

                <!-- id (opcional) -->
                <input type="hidden" th:field="*{id}" />

                <!-- Errores generales -->
                <div th:if="${#fields.hasErrors()}" class="mt-2">
                    <div class="alert alert-danger">
                        <ul>
                            <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                        </ul>
                    </div>
                </div>

                <h5 class="mt-4 border-bottom pb-2">Datos Personales y Acceso</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Email (Usuario de Acceso)</label>
                        <input class="form-control"
                               th:field="*{email}"
                               th:classappend="${#fields.hasErrors('email')}? ' is-invalid' : ''"
                               type="email" required />
                        <div class="invalid-feedback" th:errors="*{email}"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>DNI (Contraseña Inicial)</label>
                        <input class="form-control"
                               th:field="*{dni}"
                               th:classappend="${#fields.hasErrors('dni')}? ' is-invalid' : ''"
                               type="number" required />
                        <div class="invalid-feedback" th:errors="*{dni}"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Apellido</label>
                        <input class="form-control" th:field="*{apellido}" th:classappend="${#fields.hasErrors('apellido')}? ' is-invalid' : ''" required />
                        <div class="invalid-feedback" th:errors="*{apellido}"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Nombre</label>
                        <input class="form-control" th:field="*{nombre}" th:classappend="${#fields.hasErrors('nombre')}? ' is-invalid' : ''" required />
                        <div class="invalid-feedback" th:errors="*{nombre}"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label>Fecha de Nacimiento</label>
                        <input type="date" class="form-control" th:field="*{fechaNacimiento}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Teléfono</label>
                        <input class="form-control" th:field="*{telefono}" type="number" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Celular</label>
                        <input class="form-control" th:field="*{celular}" type="number" />
                    </div>
                </div>

                <h5 class="mt-4 border-bottom pb-2">Dirección</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Provincia</label>
                        <select class="form-select" th:field="*{provinciaId}" required>
                            <option value="">Seleccione una provincia</option>
                            <option th:each="prov : ${provincias}"
                                    th:value="${prov.id}"
                                    th:text="${prov.nombre}"></option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Localidad</label>
                        <input type="text" class="form-control" th:field="*{localidad}" placeholder="Escriba la localidad">
                    </div>
                </div>
                <div class="mb-3">
                    <label>Domicilio</label>
                    <input type="text" class="form-control" th:field="*{domicilio}" placeholder="Barrio, calle y número">
                </div>

                <h5 class="mt-4 border-bottom pb-2">Datos Académicos</h5>

                <div class="mt-3">
                    <label>Universidad</label>
                    <select class="form-select" disabled>
                        <option value="1" selected>Universidad Nacional de Jujuy</option>
                    </select>
                    <input type="hidden" th:field="*{idUniversidad}" value="1"/>
                </div>

                <div class="mt-3">
                    <label>Facultad</label>
                    <select class="form-select" th:field="*{idFacultad}" id="facultadSelect" required>
                        <option value="">Seleccione una facultad</option>
                        <option th:each="fac : ${facultades}" th:value="${fac.id}" th:text="${fac.etiqueta}"></option>
                    </select>
                </div>

                <div class="mt-3">
                    <label for="buscadorCarrera" class="form-label">Buscar carrera</label>
                    <input type="text" class="form-control" id="buscadorCarrera" placeholder="Escriba para buscar...">

                    <select class="form-select mt-2" th:field="*{idCarrera}" id="carreraSelect" required>
                        <option value="">Seleccione una carrera</option>
                        <!-- opciones cargadas por JS -->
                    </select>
                </div>

                <div class="mt-3">
                    <label>Colación</label>
                    <select class="form-select" th:field="*{idColacion}" id="colacionSelect">
                        <option value="">Seleccione una colación</option>
                        <th:block th:each="col : ${colaciones}">
                            <option th:value="${col.id}"
                                    th:text="${col.orden + ' (' + #temporals.format(col.fechaColacion, 'dd/MM/yyyy') + ')'}"></option>
                        </th:block>
                    </select>
                </div>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" th:field="*{tituloVerificado}" id="tituloVerificado">
                    <label class="form-check-label" for="tituloVerificado">
                        Título Verificado
                    </label>
                </div>

                <input class="form-control mt-3" th:field="*{matricula}" placeholder="Matrícula profesional"/>

                <textarea class="form-control mt-3" th:field="*{intereses}" placeholder="Intereses, proyectos, capacitaciones, hobbies..."></textarea>

                <input class="form-control mt-3" th:field="*{especializaciones}" placeholder="Especializaciones"/>

                <input class="form-control mt-3" th:field="*{idiomas}" placeholder="Idiomas"/>

                <div class="form-group mt-3">
                    <label for="posgradoInput">Posgrado</label>
                    <input type="text" class="form-control" id="posgradoInput" th:field="*{posgrado}" placeholder="Posgrados"/>
                </div>

                <div class="d-flex justify-content-end">
                    <a th:href="@{/admin/graduados}" class="btn btn-secondary me-2">Cancelar</a>
                    <button type="submit" class="btn btn-primary mt-4">Guardar Cambios</button>
                </div>
            </form>
        </div>

        <!-- axios + JS para cargar carreras y seleccionar la ya guardada -->
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

        <script th:inline="javascript">
            /* Variables iniciales desde el DTO (si vienen nulas, quedan como null) */
            let initialCarreraId = /*[[${editarGraduadoAdminDTO.idCarrera}]]*/ null;
            let initialFacultadId = /*[[${editarGraduadoAdminDTO.idFacultad}]]*/ null;

            document.addEventListener('DOMContentLoaded', function () {
                const buscador = document.getElementById("buscadorCarrera");
                const selectCarrera = document.getElementById("carreraSelect");
                const selectFacultad = document.getElementById("facultadSelect");

                // Si algún elemento falta (por alguna razón), salimos sin error.
                if (!selectCarrera || !selectFacultad) return;

                // Si vino facultad desde el DTO, la marcamos en el select
                if (initialFacultadId !== null) {
                    selectFacultad.value = initialFacultadId;
                }

                async function cargarCarreras(filtro = "", facultadId = "") {
                    try {
                        const response = await axios.get(/*[[@{/api/carreras}]]*/ "/api/carreras", {
                            params: {
                                query: filtro,
                                facultadId: facultadId
                            }
                        });

                        selectCarrera.innerHTML = '<option value="">Seleccione una carrera</option>';
                        response.data.forEach(c => {
                            const option = document.createElement("option");
                            option.value = c.id;
                            option.textContent = c.nombre;
                            // Marcar la carrera inicial (solo la primera vez)
                            if (initialCarreraId != null && String(c.id) === String(initialCarreraId)) {
                                option.selected = true;
                            }
                            selectCarrera.appendChild(option);
                        });

                        // Después de cargar la primera vez, resetear la variable para no re-seleccionar en recargas posteriores
                        initialCarreraId = null;

                    } catch (err) {
                        console.error("Error cargando carreras:", err);
                    }
                }

                // Cuando cambia la facultad, recargar carreras
                selectFacultad.addEventListener("change", e => {
                    const facultadId = e.target.value;
                    cargarCarreras(buscador.value, facultadId);
                });

                // Al escribir en buscador, recargar carreras
                buscador.addEventListener("input", e => {
                    cargarCarreras(e.target.value, selectFacultad.value);
                });

                // Carga inicial (con la facultad ya seleccionada en el DTO, si aplica)
                cargarCarreras(buscador.value, selectFacultad.value);
            });
        </script>
    </div>
</div>
</body>
</html>
