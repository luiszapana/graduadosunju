<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Editar Graduado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{layout :: layout(~{::content})}">

    <div th:fragment="content">
        <div class="container mt-4">
            <h3>Editar Graduado (Administración)</h3>

            <form th:action="@{'/admin/graduados/' + ${editarGraduadoAdminDTO.id} + '/editar'}"
                  th:object="${editarGraduadoAdminDTO}" method="post">

                <input type="hidden" th:field="*{id}" />
                <div th:if="${#fields.hasErrors()}" class="mt-2">
                    <div class="alert alert-danger">
                        <ul>
                            <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                        </ul>
                    </div>
                </div>

                <h5 class="mt-4 border-bottom pb-2">Datos Personales y Acceso</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Email (Usuario de Acceso)</label>
                        <input class="form-control"
                               th:field="*{email}"
                               th:classappend="${#fields.hasErrors('email')}? ' is-invalid' : ''"
                               type="email" required />
                        <div class="invalid-feedback" th:errors="*{email}"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>DNI (Contraseña Inicial)</label>
                        <input class="form-control" th:field="*{dni}"
                               th:classappend="${#fields.hasErrors('dni')}? ' is-invalid' : ''"
                               type="text" required />
                        <div class="invalid-feedback" th:errors="*{dni}"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Apellido</label>
                        <input class="form-control" th:field="*{apellido}" th:classappend="${#fields.hasErrors('apellido')}? ' is-invalid' : ''" required />
                        <div class="invalid-feedback" th:errors="*{apellido}"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Nombre</label>
                        <input class="form-control" th:field="*{nombre}" th:classappend="${#fields.hasErrors('nombre')}? ' is-invalid' : ''" required />
                        <div class="invalid-feedback" th:errors="*{nombre}"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label>Fecha de Nacimiento</label>
                        <input type="date" class="form-control"
                               name="fechaNacimiento"
                               th:value="${#temporals.format(editarGraduadoAdminDTO.fechaNacimiento, 'yyyy-MM-dd')}" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Teléfono</label>
                        <input class="form-control" th:field="*{telefono}" type="number" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Celular</label>
                        <input class="form-control" th:field="*{celular}" type="number" />
                    </div>
                </div>

                <h5 class="mt-4 border-bottom pb-2">Dirección</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Provincia</label>
                        <select class="form-select" th:field="*{provinciaId}" required>
                            <option value="">Seleccione una provincia</option>
                            <option th:each="prov : ${provincias}"
                                    th:value="${prov.id}"
                                    th:text="${prov.nombre}"></option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Localidad</label>
                        <input type="text" class="form-control" th:field="*{localidad}" placeholder="Escriba la localidad">
                    </div>
                </div>
                <div class="mb-3">
                    <label>Domicilio</label>
                    <input type="text" class="form-control" th:field="*{domicilio}" placeholder="Barrio, calle y número">
                </div>

                <h5 class="mt-4 border-bottom pb-2">Datos Académicos</h5>

                <div class="mt-3">
                    <label>Universidad</label>
                    <select class="form-select" disabled>
                        <option value="1" selected>Universidad Nacional de Jujuy</option>
                    </select>
                    <input type="hidden" th:field="*{idUniversidad}" value="1"/>
                </div>

                <div class="mt-3">
                    <label>Facultad</label>
                    <select class="form-select" th:field="*{idFacultad}" id="facultadSelect" required>
                        <option value="">Seleccione una facultad</option>
                        <option th:each="fac : ${facultades}" th:value="${fac.id}" th:text="${fac.etiqueta}"></option>
                    </select>
                </div>

                <div class="mt-3">
                    <label for="carreraSelect" class="form-label">Carrera</label>
                    <select class="form-select" th:field="*{idCarrera}" id="carreraSelect" required>
                        <option value="">Seleccione una carrera</option>
                    </select>
                </div>
                <div class="mt-3">
                    <label>Colación</label>
                    <select class="form-select" th:field="*{idColacion}" id="colacionSelect">
                        <option value="">Seleccione una colación</option>
                        <th:block th:each="col : ${colaciones}">
                            <option th:value="${col.id}"
                                    th:text="${col.orden + ' (' + #temporals.format(col.fechaColacion, 'dd/MM/yyyy') + ')'}"></option>
                        </th:block>
                    </select>
                </div>

                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" th:field="*{tituloVerificado}" id="tituloVerificado">
                    <label class="form-check-label" for="tituloVerificado">
                        Título Verificado
                    </label>
                </div>

                <input class="form-control mt-3" th:field="*{matricula}" placeholder="Matrícula profesional"/>

                <textarea class="form-control mt-3" th:field="*{intereses}" placeholder="Intereses, proyectos, capacitaciones, hobbies..."></textarea>

                <input class="form-control mt-3" th:field="*{especializaciones}" placeholder="Especializaciones"/>

                <input class="form-control mt-3" th:field="*{idiomas}" placeholder="Idiomas"/>

                <div class="form-group mt-3">
                    <label for="posgradoInput">Posgrado</label>
                    <input type="text" class="form-control" id="posgradoInput" th:field="*{posgrado}" placeholder="Posgrados"/>
                </div>

                <div class="d-flex justify-content-end">
                    <a th:href="@{/templates/admin/graduados}" class="btn btn-secondary me-2 mt-4">Cancelar</a>
                    <button type="submit" class="btn btn-primary mt-4">Guardar Cambios</button>
                </div>
            </form>
        </div>

        <script th:inline="javascript">
            /*<![CDATA[*/
            // =========================================================================
            //  DATOS DE CARRERAS ACTUALIZADOS CON LOS IDs REALES DE SU BASE DE DATOS
            // =========================================================================
            const carrerasPorFacultad = {
                "1": [ // Facultad de Ingeniería (id_facultad = 1)
                    { id: 1, nombre: "Ingeniería Química" },
                    { id: 2, nombre: "Ingeniería de Minas" },
                    { id: 3, nombre: "Ingeniería Industrial" },
                    { id: 4, nombre: "Ingeniería en Informática" },
                    { id: 5, nombre: "Licenciatura en Sistemas" },
                    { id: 6, nombre: "Licenciatura en Tecnología de los Alimentos" },
                    { id: 7, nombre: "Licenciatura en Ciencias Geológicas" },
                    { id: 8, nombre: "Analista Programador Universitario" },
                    { id: 9, nombre: "Tecnicatura Universitaria en Ciencias de la Tierra" },
                    { id: 10, nombre: "Técnico Universitario en Procesamiento de Minerales" },
                    { id: 11, nombre: "Técnico Universitario en Explotación de Minas" },
                    { id: 12, nombre: "Tecnicatura Universitaria en Perforaciones" },
                    { id: 13, nombre: "Tecnicatura Universitaria en Ciencias de la Tierra Orientada a Petróleo" },
                    { id: 14, nombre: "Tecnicatura Universitaria en Diseño Integral de Videojuegos" }
                ],
                "2": [ // Facultad de Ciencias Agrarias (id_facultad = 2)
                    { id: 15, nombre: "Ingeniería Agronómica" },
                    { id: 16, nombre: "Licenciatura en Bromatología" },
                    { id: 17, nombre: "Licenciatura en Ciencias Biológicas" },
                    { id: 18, nombre: "Tecnicatura Universitaria Forestal" },
                    { id: 19, nombre: "Licenciatura en Gestión Ambiental" },
                    { id: 20, nombre: "Licenciatura en Desarrollo Rural" },
                    { id: 21, nombre: "Tecnicatura Universitaria en Transformación de la Producción Agropecuaria" },
                    { id: 22, nombre: "Tecnicatura en Producción de Animales de Granja" },
                    { id: 44, nombre: "Tecnicatura Universitaria en Mecanización Agrícola" },
                    { id: 45, nombre: "Tecnicatura Universitaria en Producción Lechera" },
                    { id: 46, nombre: "Licenciatura en Bromatología - Título Intermedio" }
                ],
                "3": [ // Facultad de Ciencias Económicas (id_facultad = 3)
                    { id: 23, nombre: "Contador Público" },
                    { id: 24, nombre: "Licenciatura en Administración" },
                    { id: 25, nombre: "Licenciatura en Economía Política" }
                ],
                "4": [ // Facultad de Humanidades y Ciencias Sociales (id_facultad = 4)
                    { id: 26, nombre: "Licenciatura en Antropología" },
                    { id: 29, nombre: "Licenciatura en Comunicación Social" },
                    { id: 30, nombre: "Tecnicatura en Comunicación Digital Convergente" },
                    { id: 31, nombre: "Licenciatura en Educación para la Salud" }, // ¡Aquí está el ID 31!
                    { id: 32, nombre: "Profesorado en Educación para la Salud" },
                    { id: 33, nombre: "Licenciatura en Letras" },
                    { id: 34, nombre: "Profesorado en Letras" },
                    { id: 35, nombre: "Licenciatura en Trabajo Social" },
                    { id: 36, nombre: "Profesorado y Licenciatura en Filosofía" },
                    { id: 27, nombre: "Licenciatura en Ciencias de la Educación" },
                    { id: 28, nombre: "Profesorado en Ciencias de la Educación" },
                    { id: 38, nombre: "Licenciatura en Historia" },
                    { id: 39, nombre: "Profesorado en Historia" },
                    { id: 40, nombre: "Licenciatura en Turismo" },
                    { id: 41, nombre: "Tecnicatura en Turismo" },
                    { id: 47, nombre: "Licenciatura en Antropología - Título Intermedio" },
                    { id: 48, nombre: "Licenciatura en Comunicación Social - Título Intermedio" },
                    { id: 49, nombre: "Licenciatura en Educación para la Salud - Título Intermedio" }
                ],
                "5": [ // Escuela Superior de Ciencias de la Salud (id_facultad = 5)
                    { id: 42, nombre: "Enfermería Universitaria" }
                ],
                "6": [ // Escuela Superior de Ciencias Jurídicas y Políticas (id_facultad = 6)
                    { id: 43, nombre: "Licenciatura en Ciencia Política" }
                ]
            };
            // =========================================================================

            const selectCarrera = document.getElementById("carreraSelect");
            const selectFacultad = document.getElementById("facultadSelect");

            // Obtenemos el ID de carrera guardado y lo convertimos a cadena para la comparación estricta.
            const initialCarreraId = String(/*[[${editarGraduadoAdminDTO.idCarrera}]]*/ 0);

            // console.log("ID de Carrera inicial (DTO):", initialCarreraId); // Descomentar para debug

            /**
             * Carga las carreras basándose únicamente en el ID de la facultad seleccionada.
             * @param {string} facultadId ID de la facultad seleccionada.
             * @param {boolean} isInitialLoad Indica si es la primera carga (para pre-seleccionar).
             */
            function cargarCarreras(facultadId = "", isInitialLoad = false) {
                // Limpiar la selección de carrera
                selectCarrera.innerHTML = '<option value="">Seleccione una carrera</option>';

                const carrerasDeFacultad = carrerasPorFacultad[facultadId] || [];

                // El ID a preseleccionar es el inicial solo si es la carga inicial.
                const idToSelect = isInitialLoad ? initialCarreraId : null;

                // 1. Poblar el select
                carrerasDeFacultad.forEach(c => {
                    const option = document.createElement("option");
                    // Convertimos el ID de la carrera del objeto JS a cadena
                    const carreraIdStr = String(c.id);

                    option.value = carreraIdStr;
                    option.textContent = c.nombre;

                    // Lógica de pre-selección: Comparación estricta de cadenas.
                    if (idToSelect && carreraIdStr === idToSelect) {
                        option.selected = true;
                    }

                    selectCarrera.appendChild(option);
                });

                if (carrerasDeFacultad.length === 0 && facultadId) {
                    selectCarrera.innerHTML = '<option value="">No se encontraron carreras</option>';
                } else if (!facultadId) {
                    selectCarrera.innerHTML = '<option value="">Seleccione primero una facultad</option>';
                }
            }

            // Evento: Cuando cambia la Facultad, recargar Carreras
            selectFacultad.addEventListener("change", e => {
                const facultadId = e.target.value;
                // La bandera es 'false' (no preseleccionar la carrera inicial).
                cargarCarreras(facultadId, false);
            });

            // Carga inicial:
            document.addEventListener('DOMContentLoaded', () => {
                // La bandera es 'true' (debe intentar preseleccionar la carrera inicial).
                cargarCarreras(selectFacultad.value, true);
            });
            /*]]>*/
        </script>
    </div>
</div>
</body>
</html>