<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Datos acad√©micos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
    <h3>Datos acad√©micos</h3>
    <form th:object="${academicos}" action="/registro/datos-academicos" method="post">
        <input type="hidden" name="loginId" th:value="${loginId}">
        <!-- Campo oculto para el ID de usuario -->
        <input type="hidden" th:field="*{usuarioId}" />

        <!-- Universidad (visible pero deshabilitado) -->
        <select class="form-select" disabled>
            <option value="1" selected>Universidad Nacional de Jujuy</option>
        </select>
        <!-- Campo oculto que realmente viaja en el POST -->
        <input type="hidden" th:field="*{idUniversidad}" value="1"/>

        <!-- Facultades -->
        <select class="form-select mt-3" th:field="*{idFacultad}" id="facultadSelect">
            <option value="">Seleccione una facultad</option>
            <option th:each="fac : ${facultades}" th:value="${fac.id}" th:text="${fac.etiqueta}"></option>
        </select>

        <!-- Carrera con buscador -->
        <div class="mt-3">
            <label for="buscadorCarrera" class="form-label">Buscar carrera</label>
            <input type="text" class="form-control" id="buscadorCarrera" placeholder="Escriba para buscar...">

            <select class="form-select mt-2" th:field="*{idCarrera}" id="carreraSelect" required>
                <option value="">Seleccione una carrera</option>
            </select>
        </div>

        <div class="row">
            <!--<div class="col-md-6 mb-3">
                <label>T√≠tulo</label>
                <input type="text" class="form-control" id="titulo" readonly>
            </div>-->
            <div class="col-md-6 mb-3">
                <label>Colaci√≥n</label>
                <select class="form-select" th:field="*{idColacion}" id="colacionSelect">
                    <option value="">Seleccione una colaci√≥n</option>
                    <th:block th:each="col : ${colaciones}">
                        <option th:value="${col.id}"
                                th:text="${col.facultad.nombre + ' - ' + #temporals.format(col.fechaColacion, 'dd/MM/yyyy') + ' - ' + col.descripcion}">
                        </option>
                    </th:block>
                </select>
            </div>
        </div>

        <!-- Matr√≠cula -->
        <input class="form-control mt-3" th:field="*{matricula}" placeholder="Matricula profesional"/>

        <!-- Intereses -->
        <textarea class="form-control mt-3" th:field="*{intereses}" placeholder="Intereses, proyectos, capacitaciones, hobbies..."></textarea>

        <!-- Especializaciones -->
        <input class="form-control mt-3" th:field="*{especializaciones}" placeholder="Especializaciones"/>

        <!-- Idiomas -->
        <input class="form-control mt-3" th:field="*{idiomas}" placeholder="Idiomas"/>

        <!-- Posgrado -->
        <div class="form-group mt-3">
            <label for="posgradoInput">Posgrado</label>
            <input type="text" class="form-control" id="posgradoInput" th:field="*{posgrado}" placeholder="Posgrados"/>
        </div>

        <!-- Bot√≥n para enviar -->
        <button type="submit" class="btn btn-primary mt-3">Guardar</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const buscador = document.getElementById("buscadorCarrera");
    const selectCarrera = document.getElementById("carreraSelect");
    const selectFacultad = document.getElementById("facultadSelect"); // üö® NUEVO: obtener el select de Facultad

    async function cargarCarreras(filtro = "", facultadId = "") { // üö® MODIFICADO: aceptar facultadId
        try {
            // üö® MODIFICADO: enviar facultadId en los par√°metros
            const response = await axios.get("/api/carreras", {
                params: {
                    query: filtro,
                    facultadId: facultadId // Enviar el ID de la facultad
                }
            });

            selectCarrera.innerHTML = '<option value="">Seleccione una carrera</option>';
            response.data.forEach(c => {
                const option = document.createElement("option");
                option.value = c.id;
                option.textContent = c.nombre;
                selectCarrera.appendChild(option);
            });
        } catch (err) {
            console.error("Error cargando carreras:", err);
        }
    }

    // üö® NUEVO EVENTO: Cuando cambia la Facultad, recargar Carreras
    selectFacultad.addEventListener("change", e => {
        const facultadId = e.target.value;
        // La lista de carreras debe filtrarse por la facultad seleccionada
        cargarCarreras(buscador.value, facultadId);
    });

    // Evento de b√∫squeda de carrera permanece igual, pero ahora usa la facultad seleccionada
    buscador.addEventListener("input", e => {
        cargarCarreras(e.target.value, selectFacultad.value);
    });


    // primera carga (solo si no hay una facultad seleccionada por defecto)
    // Si hay un valor precargado, cargarCarreras se llamar√° despu√©s de la carga inicial del DTO en el controlador.
    // Aqu√≠ usamos la que el usuario haya seleccionado o la vac√≠a
    cargarCarreras(buscador.value, selectFacultad.value);
</script>
</body>
</html>
